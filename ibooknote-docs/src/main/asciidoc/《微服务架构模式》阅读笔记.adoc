= 《微服务架构模式》阅读笔记

相关扩展阅读

_《The Art of Scalability: Scalable Web Architecture, Processes, and Organizations for the Modern Enterprise》_

中文版：架构即未来

== 1. 逃离单体地狱

主要内容：

* 单体地狱的征兆（中文版翻译成“特征”），如何借助微服务架构逃离单体地狱
* 微服务架构的基本特征，好处和弊端
* 微服务如何实现大型、复杂应用的DevOps开发风格
* 微服务架构模式语言

=== 1.1. 进入单体地狱的过程

==== 1.1.3. 单体架构的好处

* 开发简单
* 容易进程大规模修改
* 测试简单直观
* 部署简单
* 横向扩展容易

这些好处仅仅体现在应用规模相对较小的前期阶段，随着项目的增长，功能的增多，这些好处也都不复存在。

==== 1.1.4. 单体地狱

单体架构存在巨大的局限，应用程序不断扩张，导致代码库膨胀、研发团队规模壮大、团队管理成本不断提高。

当单体架构下，大规模多团队协作开发效率会显著下降，沟通成本上升，敏捷开发和部署已变得不可能。

单体变得过于庞大、复杂的时候，任何一个人都很难理解它的全部，修改bug和增加新功能也就变得困难、耗时，恶性循环

* 过度复杂会吓退开发者
* 开发速度缓慢 -- 开发慢、构建慢、测试慢
* 从代码提交到实际部署周期很长，容易出问题 -- 多组、多人同时提交、排队等待测试
* 难以按照模块特性扩展
* 交付可靠的单体应用面临挑战 -- 一个模块出错，将影响整个单体应用
* 需要长期依赖某个可能已经过时的技术栈，框架无法升级或更换

=== 1.3. 通过本书可学到的内容

* 微服务架构的特点、好处、弊端，适用场景
* 分布式数据管理模式
* 有效的微服务测试策略
* 微服务部署选项
* 单体应用向微服务架构重构的策略

* 使用微服务架构模式设计应用
* 为服务开发业务逻辑
* 使用sagas管理跨服务数据一致性
* 实现跨服务查询
* 高效的测试微服务
* 开发出安全、可配置、可观察、可交付的服务
* 重构已有的单体应用

=== 1.4. 微服务架构

架构的重要性，在于它影响了服务质量需求，也称为非功能性需求、质量属性或其他-ilities。

技术团队通过模块化开发、自动化测试等手段，可能减缓项目陷入单体地狱的速度，但无法避免 -- 它们无法避免大规模团队在单体应用程序上的协同工作问题，也不能解决日益过时的技术栈问题。

唯一的出路是：迁移到微服务架构

微服务字面上的理解：

* 服务是微小的，代码不超过100行
* 服务的开发周期限制在两周以内

相对靠谱的定义： 面向服务的架构，由松耦合和具有边界上下文的元素组成。

==== 1.4.1. 扩展立方体和服务

扩展立方体：三位可扩展模型，源于《The Art of Scalability》

* X轴扩展 -- 横向扩展，在多个实例之间实现负载均衡
* Z轴扩展 -- 数据分区，如按用户id均匀分布到多个实例
* Y轴扩展 -- 按功能拆分为服务

X、Z轴扩展可有效提升应用的吞吐量和可用性。但无法解决日益增长的开发问题和应用复杂性。

终极目标是使用Y轴扩展，将单体应用扩展为一组服务，再借助X轴和Z轴扩展。

微服务架构的概括性定义：

_把应用程序功能性分解为一组服务的架构风格_

和规模大小无关，重要的是每个服务有专注的、内聚的一组职责。

延伸理解：

_类似数学中的的分而治之概念，将大而复杂的问题拆解成小问题，解决每个小问题，也就解决了大问题。_

==== 1.4.3. 每个微服务有自己的数据库

每个服务有自己的数据库不是说有自己的数据库服务器。Chapter 2详细讨论这个主题。

==== 1.4.5. 微服务架构与SOA比较

SOA -- service-oriented architecture

SOA和微服务的架构风格类似，都是将系统设计成一个服务集合。但深层来看，它们有明显的不同：

* 内部服务间通信 -- 智能管道（企业总线） & 异步消息或REST/gRPC
* 数据 -- 全局数据模型，共享数据库 & 服务独有数据库
* 典型服务 -- 大的单体应用 & 小服务

它们通常使用不同的技术栈：

* SOA -- SOAP、WS*标准、ESB、smart pipe
* 微服务 -- 

==== 1.6.3. 微服务架构模式语言概述

微服务架构下，模式分为三层：

* 基础设施模式 -- 解决不影响开发的基础设施问题
* 应用基础设施模式 -- 解决影响开发的基础设施问题
* 应用模式 -- 解决开发者面对的问题

*将应用拆分成服务的模式*

两种分解模式：

* 按业务能力分解
* 按子领域分解

*通信模式*

5组服务间通信模式：

* Communication style -- 使用什么样的IPC机制？
* 发现 -- 服务的客户端如何确定要访问的服务的IP地址？
* 可靠性 -- 如何保证服务间的通信是可靠的，即使服务不可用情况下？
* 支持事务的消息 -- 如何将发送消息和发布事件与数据库事务集成到一起，以便更新业务数据？
* 外部API -- 应用的客户端如何与服务通信？

*数据一致性模式用来实现事务管理*

传统的两步提交（2PC）方式已不适合现代应用。需要使用Saga模式管理数据一致性。

*微服务架构下数据查询模式*

服务的数据只能通过API访问，不能使用直连数据库的分布式查询。

* API组合模式 -- 多个服务的API组合
* CQRS -- 命令、查询、职责、隔离模式，管理一个或多个简单查询副本

*服务部署模式*

